#!/bin/sh

# Function to get unique session names
get_unique_sessions() {
    tmux list-sessions -F '#{session_name}' | sed 's/^floating_//; s/_[0-9]*$//' | sort -u
}

# Function to get all sessions for a given base name
get_sessions_for_base() {
    base_name="$1"
    tmux list-sessions -F '#{session_name}' | grep -E "^(floating_${base_name}_[0-9]*)|(${base_name})$"
}

# Function to list sessions
list_sessions() {
    get_unique_sessions
}

# Function to kill sessions
kill_session() {
    base_name="$1"
    sessions_to_remove=$(get_sessions_for_base "${base_name}")
    echo $sessions_to_remove
    printf "%s\n" "${sessions_to_remove}" | while IFS= read -r session; do
      tmux kill-session -t "${session}" && printf "Removed session: %s\n" "${session}" >&2
    done
}

# Main script
main() {
    case "$1" in
        list)
            list_sessions
            ;;
        kill)
            if [ -z "$2" ]; then
                echo "Error: No session name provided for kill command" >&2
                exit 1
            fi
            kill_session "$2"
            ;;
        *)
            echo "Usage: $0 {list|kill <session_name>}" >&2
            exit 1
            ;;
    esac
}

# Run the main function with all arguments
main "$@"
