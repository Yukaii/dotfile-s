#!/bin/sh
#
# pick recent file
#
# requires:
# - fzf (https://github.com/junegunn/fzf)
# - bat (change to your liking) (https://github.com/sharkdp/bat)
#
# for this to work, add the following in kakrc:
# (requires sponge from moreutils: https://joeyh.name/code/moreutils/)
# hook global BufCreate [^*].* %{
#     nop %sh{
#         mru=~/.cache/kak-mru
#         echo "$kak_buffile" | awk '!seen[$0]++' - "$mru" | sponge "$mru"
#     }
# }

preview_cmd="bat --color=always --line-range=:500"
pwd=$(echo $PWD | sed 's|/|-|g')
mru=~/.cache/kak-mru-"$pwd"

[ ! -f "$mru" ] && touch "$mru"

# Clean up: Remove non-existing files from MRU
temp_mru=$(mktemp)
while read -r path; do
    [ -e "$path" ] && echo "$path" >> "$temp_mru"
done < "$mru"
mv "$temp_mru" "$mru"

# Create a temp file with relative paths
relative_mru=$(mktemp)
awk -v pwd="$PWD" '{ sub("^" pwd "/", "", $0); print }' "$mru" > "$relative_mru"

selected=$(fzf --height 100% --prompt 'mru> ' --preview "$preview_cmd {}" < "$relative_mru")
if [ -n "$selected" ]; then
    kks edit "$PWD/$selected"
fi

# Cleanup temporary file
rm "$relative_mru"
