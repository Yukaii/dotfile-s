#!/usr/bin/env bash

get_pane_direction() {
  general_direction=$1

  case $general_direction in
    bottom)
      echo "down"
      ;;
    left)
      echo "left"
      ;;
    right)
      echo "right"
      ;;
    top)
      echo "up"
      ;;
    *)
      echo "Error: Invalid direction. Only 'bottom' and 'left' are supported." >&2
      return 1
      ;;
  esac
}

fpath="$1"
# Set the panel direction to the second argument, defaulting to 'right' if not provided

# top/bottom/left/right 
direction="${2:-right}"

# none, v, h
split="$3"

# up/down/left/right
pane_direction=$(get_pane_direction $direction)

# Use the pane_direction variable for get-pane-direction and split-pane commands
pane_id=$(wezterm cli get-pane-direction $pane_direction)
if [ -z "${pane_id}" ]; then
  # Use --$pane_direction to dynamically construct the argument for split-pane
  pane_id=$(wezterm cli split-pane --$direction --percent 80)
fi

program=$(wezterm cli list | awk -v pane_id="$pane_id" '$3==pane_id { print $6 }')
if [ "$program" = "hx" ]; then
  # Send :open command to hx in the specified pane
  if [ -n "$split" ]; then
    case $split in
      v)
        echo ":vs\r" | wezterm cli send-text --pane-id $pane_id --no-paste
        ;;
      h)
        echo ":hs\r" | wezterm cli send-text --pane-id $pane_id --no-paste
        ;;
    esac
  fi
  # noted: add a little whitespace to the end to workaround the issue that inserted a "j" at the end of line
  echo -e ":open ${fpath}\r" | wezterm cli send-text --pane-id $pane_id --no-paste > /dev/null
else
  # Start hx with the given file path in the specified pane
  echo "hx ${fpath}" | wezterm cli send-text --pane-id $pane_id --no-paste > /dev/null
fi

# Activate the pane in the specified direction
wezterm cli activate-pane-direction --pane-id $pane_id $pane_direction
